---
title: "Lab Week 8"
author: "Sandy Carter"
date: "3/8/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Point Pattern Analysis Oil Spill Texas

### Load packages
```{r, message = FALSE}
library(tidyverse)
library(sf)
library(tmap)
library(leaflet)
library(spatstat)
library(maptools)
```

### Make column graph of Texas Oil Spills
```{r, message=FALSE}
oil_spills <- read_csv("oil_spills.csv")

df <- oil_spills %>% 
  filter(`Accident State` == "TX" & `Accident Year` < 2017) %>% 
  group_by(`Accident Year`) %>%  # Create groups by different years so we can find net oil loss by year
  summarise(Loss = sum(`Net Loss (Barrels)`))

colnames(df) <- c("Year", "Loss")

ggplot(df, aes(x = Year, y = Loss)) +
  geom_col()
# Loss is in barrels. This is about 1/2 as much as Exxon Valdez. (but land to marine is apples/oranges)
```

### Leaflet plot of spill locations in TX in 2016

```{r}
df_loc <- oil_spills %>% 
  filter(`Accident State` == "TX" & `Accident Year` == 2016) %>% 
  select(Latitude, Longitude, `Net Loss (Barrels)`)

colnames(df_loc) <- c("latitude", "longitude", "net_loss")

oil_sf <- st_as_sf(df_loc, coords = c("longitude", "latitude"), crs = 4326)   # Change lat and long into spatial data for R; makes spatial information sticky 

leaflet(oil_sf) %>% 
  addTiles() %>% 
  addMarkers()

```

### Make tmap of oil spills with Texas State shape file (to prep for spatial point pattern analysis)
```{r}
states <- st_read(dsn = ".", layer = "states")

tex_border <- states %>% 
  filter(STATE_NAME == "Texas") %>% # select texas
  st_transform(4326) # Transform coordinate reference system (need polygons to align correctly); using transform b/c it already had one--not setting it, but changing it

#plot(tex_border)

tm_shape(tex_border) +
  tm_polygons() +
  tm_shape(oil_sf) +
  tm_dots(size = 0.3)
```
  
**Are these spatially random or not? Does this point pattern follow CRS? (Doing this on oil spills isn't the best in that these are dependent on oil locations, but we're going to use it as an example here)**

### Convert the data to spatial points pattern (combination of point data and the bounding window)
```{r}
# identify points
spill_sp <- as(oil_sf, "Spatial") # convert back from simple features to dataframe
spill_ppp <- as(spill_sp, "ppp") #Change class to ppp (point pattern analysis)

# identify bounding window
tx_sp <- as(tex_border, "Spatial")
tx_owin <- as(tx_sp, "owin") #Take texas spatial and set it as window for ppp

# Put points and bounding window together
all_ppp <- ppp(spill_ppp$x, spill_ppp$y, window = tx_owin) #x and y are corresponding lat and long. R omits points that don't align within the polygon

```



